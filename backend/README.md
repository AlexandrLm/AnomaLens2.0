# AnomaLens Backend API

Этот каталог содержит бэкенд-часть приложения AnomaLens, реализованную на Python с использованием FastAPI. API предоставляет эндпоинты для управления данными, имитирующими интернет-магазин, генерации тестовых данных, а также для обучения и применения моделей обнаружения аномалий.

## Основные Технологии

*   **Фреймворк:** FastAPI
*   **База данных:** SQLite (через SQLAlchemy)
*   **ML Библиотеки:** Scikit-learn, Pandas
*   **Генерация данных:** Faker

## Настройка и Запуск

### 1. Предварительные требования

*   Python 3.8+
*   pip (менеджер пакетов Python)

### 2. Установка

1.  **Клонируйте репозиторий** (если еще не сделано).
2.  **Перейдите в корневую папку проекта** (`AnomaLens2.0`).
3.  **Создайте виртуальное окружение:**
    ```bash
    python -m venv backend/.venv
    ```
4.  **Активируйте виртуальное окружение:**
    *   Windows (PowerShell): `.\backend\.venv\Scripts\Activate.ps1`
    *   Windows (cmd.exe): `backend\.venv\Scripts\activate.bat`
    *   macOS/Linux: `source backend/.venv/bin/activate`
    (Вы должны увидеть `(.venv)` в начале строки терминала)
5.  **Установите зависимости:**
    ```bash
    pip install -r backend/requirements.txt
    ```
6.  **Настройте переменные окружения:**
    *   Создайте файл `.env` в папке `backend`.
    *   Добавьте в него строку с путем к базе данных SQLite:
        ```dotenv
        DATABASE_URL=sqlite:///./anomalens.db
        ```
        (Файл `anomalens.db` будет создан автоматически в папке `backend` при первом запуске).

### 3. Запуск приложения

Находясь в **корневой папке проекта** (`AnomaLens2.0`) и с **активным виртуальным окружением**, выполните команду:

```bash
uvicorn backend.main:app --reload --port 8001
```

*   `--reload`: Сервер будет автоматически перезапускаться при изменениях в коде.
*   `--port 8001`: Запускает сервер на порту 8001 (может понадобиться, если порт 8000 занят).

После запуска сервер будет доступен по адресу `http://127.0.0.1:8001`.
Интерактивная документация API (Swagger UI) доступна по адресу `http://127.0.0.1:8001/docs`.

## Структура Проекта (`backend/`)

*   `main.py`: Точка входа приложения FastAPI, инициализация и подключение роутеров.
*   `database.py`: Настройка SQLAlchemy, создание движка и сессий БД.
*   `models.py`: Определения моделей данных SQLAlchemy (таблицы БД).
*   `schemas.py`: Определения схем Pydantic для валидации API и сериализации.
*   `crud.py`: Функции для взаимодействия с базой данных (Create, Read, Update, Delete).
*   `api/`: Каталог с роутерами API (эндпоинтами).
    *   `store.py`: Эндпоинты для управления данными магазина (категории, товары, клиенты, заказы).
    *   `activities.py`: Эндпоинты для записи и получения активностей пользователей.
    *   `simulator.py`: Эндпоинт для генерации тестовых данных.
    *   `anomalies.py`: Эндпоинты для обучения и детекции аномалий.
*   `simulator/`: Модуль для генерации тестовых данных.
    *   `generator.py`: Логика генерации данных с использованием Faker.
*   `ml_service/`: Модуль для сервиса машинного обучения.
    *   `detector.py`: Реализация детекторов аномалий (Isolation Forest, Z-score, DBSCAN), включая расчет признаков.
    *   `saved_models/`: Каталог для сохранения обученных моделей и статистики (добавлен в `.gitignore`).
*   `requirements.txt`: Список зависимостей Python.
*   `.env`: Файл переменных окружения (не добавляется в Git).
*   `.gitignore`: Файл для исключения ненужных файлов из Git.
*   `README.md`: Этот файл.

## Основные API Эндпоинты

(См. `http://127.0.0.1:8001/docs` для полной информации)

*   **`/api/store/*`**: CRUD операции для категорий, товаров, клиентов, заказов.
*   **`/api/activities/*`**: Запись и получение активностей пользователей с фильтрацией.
*   **`/api/simulator/generate`**: `POST` запрос для генерации тестовых данных. Позволяет настроить количество генерируемых сущностей и долю аномалий.
*   **`/api/anomalies/train`**: `POST` запрос для запуска обучения/подготовки выбранных алгоритмов (`isolation_forest`, `statistical_zscore`, `dbscan`) на последних N активностях. Обучение происходит в фоновом режиме.
*   **`/api/anomalies/detect`**: `POST` запрос для детекции аномалий с использованием выбранных алгоритмов на последних N активностях. Возвращает словарь с результатами для каждого алгоритма.

## ML Сервис

*   Реализованы детекторы: Isolation Forest, Statistical Z-score, DBSCAN.
*   Производится расчет признаков (feature engineering), включая временные ряды и частотные характеристики.
*   Модель Isolation Forest и статистики для Z-score сохраняются в `backend/ml_service/saved_models/` после обучения и загружаются при старте/использовании. 