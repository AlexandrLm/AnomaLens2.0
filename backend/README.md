# AnomaLens Backend API

Этот каталог содержит бэкенд-часть приложения AnomaLens, реализованную на Python с использованием FastAPI. API предоставляет эндпоинты для управления данными, имитирующими интернет-магазин, генерации тестовых данных, а также для обучения и применения моделей обнаружения аномалий в пользовательских активностях и заказах.

## Основные Технологии

*   **Фреймворк:** FastAPI
*   **База данных:** SQLite (через SQLAlchemy)
*   **ML Библиотеки:** Scikit-learn, Pandas, NumPy, TensorFlow/Keras
*   **Генерация данных:** Faker
*   **Асинхронный сервер:** Uvicorn
*   **Валидация данных:** Pydantic

## Настройка и Запуск

### 1. Предварительные требования

*   Python 3.8+
*   pip (менеджер пакетов Python)

### 2. Установка

1.  **Клонируйте репозиторий** (если еще не сделано).
2.  **Перейдите в корневую папку проекта** (`AnomaLens2.0`).
3.  **Создайте виртуальное окружение:**
    ```bash
    python -m venv backend/.venv
    py -3.11 -m venv backend/.venv
    ```
4.  **Активируйте виртуальное окружение:**
    *   Windows (PowerShell): `.\backend\.venv\Scripts\Activate.ps1`
    *   Windows (cmd.exe): `backend\.venv\Scripts\activate.bat`
    *   macOS/Linux: `source backend/.venv/bin/activate`
    (Вы должны увидеть `(.venv)` в начале строки терминала)
5.  **Установите зависимости:**
    ```bash
    pip install -r backend/requirements.txt
    ```
6.  **Настройте переменные окружения:**
    *   Создайте файл `.env` в папке `backend`.
    *   Добавьте в него строку с путем к базе данных SQLite:
        ```dotenv
        DATABASE_URL=sqlite:///./anomalens.db
        ```
        (Файл `anomalens.db` будет создан автоматически в папке `backend` при первом запуске).

### 3. Запуск приложения

Находясь в **корневой папке проекта** (`AnomaLens2.0`) и с **активным виртуальным окружением**, выполните команду:

```bash
uvicorn backend.main:app --reload --port 8001
```

*   `--reload`: Сервер будет автоматически перезапускаться при изменениях в коде.
*   `--port 8001`: Запускает сервер на порту 8001 (может понадобиться, если порт 8000 занят).

После запуска сервер будет доступен по адресу `http://127.0.0.1:8001`.
Интерактивная документация API (Swagger UI) доступна по адресу `http://127.0.0.1:8001/docs`.

## Структура Проекта (`backend/`)

*   `main.py`: Точка входа приложения FastAPI, инициализация, настройка CORS, подключение роутеров API.
*   `database.py`: Настройка SQLAlchemy, создание движка (`engine`), фабрики сессий (`SessionLocal`) и функции-зависимости `get_db`. Использует переменную окружения `DATABASE_URL` из файла `.env`.
*   `models.py`: Определения моделей данных SQLAlchemy (ORM-классы, соответствующие таблицам БД: `Category`, `Product`, `Customer`, `Order`, `OrderItem`, `UserActivity`, `Anomaly`, `Setting`).
*   `schemas.py`: Определения схем Pydantic для валидации данных API (запросов и ответов), включая базовые схемы, схемы для создания (`Create`) и схемы для чтения (например, `UserActivity`, `UserActivityResponse`, `SimpleActivityHistoryItem`). Используются для обеспечения корректности данных, передаваемых между клиентом и сервером, и для автоматической генерации документации API.
*   `crud.py`: Функции для взаимодействия с базой данных (Create, Read, Update, Delete) для всех моделей. Используются сессии SQLAlchemy.
*   `api/`: Каталог с роутерами API FastAPI (`APIRouter`), группирующими эндпоинты по функциональности.
    *   `store.py`: Эндпоинты для управления данными магазина (категории, товары, клиенты, заказы).
    *   `activities.py`: Эндпоинты для записи и получения активностей пользователей, включая получение контекста сессии.
    *   `simulator.py`: Эндпоинт для запуска генерации тестовых данных.
    *   `anomalies.py`: Эндпоинты для обучения моделей, детекции аномалий и получения информации об обнаруженных аномалиях.
    *   `dashboard.py`: Эндпоинты для получения сводной статистики (количества сущностей).
    *   `charts.py`: Эндпоинты для получения данных, агрегированных для построения графиков.
    *   `settings.py`: Эндпоинты для чтения и обновления настроек приложения (например, параметров ML).
*   `simulator/`: Модуль для генерации тестовых данных.
    *   `generator.py`: Логика генерации категорий, товаров, клиентов, заказов и активностей с использованием Faker и возможностью добавления аномальных данных (заказы с аномальной суммой, пачки активности, неудачные логины).
*   `ml_service/`: Модуль для сервиса машинного обучения.
    *   `common.py`: Общие константы (путь к моделям, списки признаков) и функция `engineer_features` для расчета признаков из сырых данных активностей.
    *   `detector.py`: Реализация детекторов аномалий (Isolation Forest, Statistical Z-score, DBSCAN), включая их обучение (`train`) и применение (`detect`). Содержит фабрику `get_detector` для получения экземпляра нужного детектора.
    *   `autoencoder_detector.py`: Реализация детектора аномалий на основе Автоэнкодера (Keras/TensorFlow).
    *   `preprocessing.py`: (В настоящее время пустой) Планировался для шагов предобработки.
    *   `saved_models/`: Каталог для сохранения обученных моделей, скейлеров и статистики (добавлен в `.gitignore`).
*   `requirements.txt`: Список зависимостей Python.
*   `.env`: Файл переменных окружения (содержит `DATABASE_URL`, не добавляется в Git).
*   `.gitignore`: Файл для исключения ненужных файлов и каталогов из Git.
*   `README.md`: Этот файл.

## Модели Данных (`models.py`)

Основные сущности, хранящиеся в базе данных:

*   **`Category`**: Категория товаров (`id`, `name`, `description`).
*   **`Product`**: Товар (`id`, `name`, `description`, `price`, `category_id`). Связан с `Category`.
*   **`Customer`**: Клиент (`id`, `email`, `first_name`, `last_name`, `created_at`).
*   **`Order`**: Заказ (`id`, `customer_id`, `created_at`, `total_amount`, `status`). Связан с `Customer`.
*   **`OrderItem`**: Позиция в заказе (`id`, `order_id`, `product_id`, `quantity`, `price`). Связана с `Order` и `Product`.
*   **`UserActivity`**: Активность пользователя (`id`, `customer_id`, `session_id`, `timestamp`, `action_type`, `details` (JSON), `ip_address`, `user_agent`). Связана с `Customer`.
*   **`Anomaly`**: Запись об обнаруженной аномалии (`id`, `entity_type`, `entity_id`, `detection_timestamp`, `description`, `severity`, `detector_name`, `details` (JSON), `anomaly_score`).
*   **`Setting`**: Пара ключ-значение для хранения настроек приложения (`key`, `value`).

## API Эндпоинты

Полная интерактивная документация (Swagger UI) доступна по адресу `http://127.0.0.1:8001/docs` после запуска сервера.

### Магазин (`/api/store`)

*   **Категории (`/categories`)**:
    *   `POST /`: Создать новую категорию.
    *   `GET /`: Получить список категорий.
    *   `GET /{category_id}`: Получить категорию по ID.
*   **Товары (`/products`)**:
    *   `POST /`: Создать новый товар.
    *   `GET /`: Получить список товаров.
    *   `GET /{product_id}`: Получить товар по ID.
*   **Клиенты (`/customers`)**:
    *   `POST /`: Создать нового клиента.
    *   `GET /`: Получить список клиентов.
    *   `GET /{customer_id}`: Получить клиента по ID.
*   **Заказы (`/orders`)**:
    *   `POST /`: Создать новый заказ (принимает `customer_id` и список `items`).
    *   `GET /`: Получить список заказов (опционально фильтруется по `customer_id`).
    *   `GET /{order_id}`: Получить заказ по ID.

### Активности Пользователей (`/api/activities`)

*   `POST /`: Записать новую активность пользователя.
*   `GET /`: Получить список активностей (с пагинацией, возвращает `UserActivityResponse` с `totalCount` и списком `data`).
*   `GET /{activity_id}`: Получить активность по ID.
*   `GET /{activity_id}/context/session_history`: Получить список всех действий пользователя (`SimpleActivityHistoryItem`) в рамках той же сессии, что и указанная активность. Включает `session_id` для каждой активности в ответе.

### Симулятор Данных (`/api/simulator`)

*   `POST /generate`: Запустить генерацию тестовых данных. Принимает конфигурацию в теле запроса (`num_customers`, `num_products`, `num_orders`, `num_activities`, параметры для генерации аномалий). Возвращает количество созданных сущностей.

### Обнаружение Аномалий (`/api/anomalies`)

*   `POST /train`: Запустить обучение моделей (`Isolation Forest`, `Statistical Z-score`, `Autoencoder`) в фоновом режиме. Принимает параметры обучения (`limit`, `z_threshold`, опционально `entity_type` - 'activity' или 'order').
*   `POST /detect`: Запустить обнаружение аномалий с использованием указанных алгоритмов (`statistical_zscore`, `isolation_forest`, `dbscan`, `autoencoder`) для последних N записей (`limit`). Принимает параметры (`entity_type`, `algorithms`, `limit`, параметры для Z-score и DBSCAN). Сохраняет обнаруженные аномалии в БД.
*   `GET /`: Получить **консолидированный** список обнаруженных аномалий. Аномалии группируются по сущности (`entity_type`, `entity_id`), показывая, какие детекторы сработали, время последнего обнаружения и общую серьезность. (Пагинация `skip`, `limit`).
*   `GET /anomaly/{anomaly_id}`: Получить детальную информацию об одной конкретной записи аномалии (из таблицы `anomalies`) и связанной с ней сущности (активность или заказ). (*Примечание: путь может отличаться от фактического, сверьтесь с `/docs`*)
*   `DELETE /`: Удалить все записи об аномалиях из таблицы `anomalies`.

### Панель Управления (`/api/dashboard`)

*   `GET /summary`: Получить общую сводку по количеству сущностей в БД (клиенты, товары, заказы, активности, категории).

### Данные для Графиков (`/api/charts`)

*   `GET /activity_timeline`: Получить данные для графика активности пользователей по времени (группировка по дням или часам).
*   `GET /anomaly_summary`: Получить данные для графика распределения обнаруженных аномалий по детекторам.

### Настройки (`/api/settings`)

*   `GET /`: Получить текущие значения настроек ML (извлекаются из БД или используются значения по умолчанию).
*   `PUT /`: Обновить значения настроек ML. Принимает словарь `{key: value}`.

## ML Сервис (`ml_service/`)

Модуль отвечает за обнаружение аномалий в данных пользовательских активностей (`UserActivity`) и, потенциально, в других сущностях (например, заказах).

### Инженерия Признаков (`common.engineer_features`)

Функция `engineer_features` принимает список объектов `UserActivity` и выполняет следующие шаги:
1.  Преобразует данные в Pandas DataFrame.
2.  Рассчитывает признаки на основе временных рядов и контекста:
    *   Временные характеристики: `timestamp_hour`, `timestamp_dayofweek`.
    *   Детали активности: `details_order_total`, `details_quantity` (из JSON).
    *   Признаки на основе IP: `time_since_last_activity_ip` (время с последней активности с того же IP), `actions_in_last_5min_ip` (кол-во действий с IP за 5 мин), `failed_logins_in_last_15min_ip` (кол-во неудачных логинов с IP за 15 мин).
    *   Обработка ID клиента: `customer_id` (заполнение -1 для анонимов).
3.  Выполняет очистку типов данных, обработку NaN и бесконечных значений.
4.  Возвращает DataFrame с рассчитанными числовыми признаками (`NUMERICAL_FEATURES`) и категориальным признаком (`CATEGORICAL_FEATURE = 'action_type'`).

### Детекторы Аномалий

Реализовано несколько алгоритмов обнаружения аномалий:

1.  **`StatisticalDetector` (Z-score)** (`detector.py`):
    *   **Принцип:** Рассчитывает среднее и стандартное отклонение для каждого числового признака (`NUMERICAL_FEATURES`) во время "обучения" (`train`). Сохраняет статистики в файл `_stats.joblib`.
    *   **Детекция (`detect`):** Для новых данных рассчитывает Z-оценку ((значение - среднее) / ст. отклонение). Если абсолютное значение Z-оценки превышает порог (`z_threshold`, настраивается через API `/settings`), активность считается аномальной по данному признаку.
    *   **Поддерживаемые сущности:** `activity`, `order` (требует отдельного обучения статистик).

2.  **`IsolationForestDetector`** (`detector.py`):
    *   **Принцип:** Использует ансамбль "изолирующих деревьев" (`sklearn.ensemble.IsolationForest`) для выявления выбросов. Аномалии легче изолировать (требуется меньше разбиений).
    *   **Подготовка:** Перед обучением/детекцией выполняет One-Hot Encoding для `action_type` и масштабирование (`StandardScaler`) для всех числовых и OHE-признаков. Scaler и OHE-категории сохраняются (`iforest_detector.joblib`, `iforest_scaler.joblib`, `iforest_ohe.joblib`).
    *   **Обучение (`train`):** Обучает модель Isolation Forest на подготовленных данных. Сохраняет модель.
    *   **Детекция (`detect`):** Применяет обученную модель к новым данным. Метод `decision_function` возвращает оценку аномальности (чем меньше, тем аномальнее). Точки с оценкой ниже порога (определяется параметром `contamination` модели) считаются аномалиями.
    *   **Поддерживаемые сущности:** `activity`.

3.  **`DbscanDetector`** (`detector.py`):
    *   **Принцип:** Алгоритм кластеризации на основе плотности (`sklearn.cluster.DBSCAN`). Точки, не попадающие ни в один плотный кластер, считаются шумом (аномалиями).
    *   **Подготовка:** Аналогична `IsolationForestDetector` (OHE + StandardScaler). Не требует явного обучения, но использует Scaler, обученный на исторических данных (обычно вместе с IF).
    *   **Детекция (`detect`):** Применяет DBSCAN к подготовленным данным. Точки с меткой кластера `-1` считаются аномалиями. Параметры `eps` (радиус окрестности) и `min_samples` (минимальное число соседей) настраиваются через API `/settings` или передаются в `/detect`.
    *   **Поддерживаемые сущности:** `activity`.

4.  **`AutoencoderDetector`** (`autoencoder_detector.py`):
    *   **Принцип:** Использует нейронную сеть (Автоэнкодер на Keras/TensorFlow) для сжатия данных в скрытое представление и последующего восстановления. Аномалии обычно плохо восстанавливаются, что приводит к высокой ошибке реконструкции (MSE - Mean Squared Error).
    *   **Подготовка:** Аналогична другим детекторам (OHE + StandardScaler). Сохраняет модель (`.keras`), Scaler и OHE-категории отдельно.
    *   **Обучение (`train`):** Обучает автоэнкодер на "нормальных" данных, минимизируя ошибку реконструкции. Использует раннюю остановку.
    *   **Детекция (`detect`):** Прогоняет новые данные через обученный автоэнкодер и вычисляет MSE между входом и выходом. Если MSE превышает порог (`anomaly_threshold`), активность считается аномальной.
    *   **Поддерживаемые сущности:** `activity`.
    *   **Зависимость:** Требует установленной библиотеки `tensorflow`.

### Сохранение и Загрузка Моделей

Обученные модели (`IsolationForest`, `Autoencoder`), статистики (`StatisticalDetector`) и объекты предобработки (`StandardScaler`, OHE-категории) сохраняются в каталог `backend/ml_service/saved_models/` с помощью `joblib` или Keras API. Детекторы автоматически пытаются загрузить сохраненное состояние при инициализации.

## Симулятор Данных (`simulator/generator.py`)

Модуль `generator.py` содержит функции для наполнения базы данных тестовыми данными, имитирующими работу интернет-магазина.

*   Генерирует: Категории, Товары, Клиентов, Заказы, Активности пользователей.
*   Использует библиотеку `Faker` для создания реалистичных имен, email, IP-адресов и т.д.
*   **Генерация аномалий:**
    *   **Заказы:** С вероятностью `order_anomaly_rate` генерирует заказы с аномально высокой или низкой общей суммой (`total_amount`).
    *   **Активности:** С вероятностью `activity_anomaly_rate` генерирует аномальные паттерны:
        *   **Burst:** Пачка одинаковых действий (`view_product`, `add_to_cart`, `search`) с одного IP за короткое время.
        *   **Failed Logins:** Серия неудачных попыток входа (`failed_login`) для одного email с одного IP.
*   Запускается через API эндпоинт `POST /api/simulator/generate`.

## Настройки (`api/settings.py`)

Приложение позволяет хранить и изменять некоторые параметры (в основном для ML-сервиса) в таблице `settings` базы данных.

*   Текущие поддерживаемые настройки (ключи в `DEFAULT_SETTINGS`):
    *   `limit`: Максимальное количество записей для обучения/детекции.
    *   `z_threshold`: Порог для Z-score детектора.
    *   `dbscan_eps`: Параметр `eps` для DBSCAN.
    *   `dbscan_min_samples`: Параметр `min_samples` для DBSCAN.
*   Настройки читаются через `GET /api/settings` и обновляются через `PUT /api/settings`.
*   Значения хранятся в БД как строки, но API возвращает и принимает их с ожидаемыми типами данных (int, float).

*Этот README был обновлен для отражения текущей структуры и функциональности.* 